# 软件研发类 Agent 七步闭环流程（对齐条款与验证）

> 流程：意图（人） → 生成确认书（模板） → 人确认 → 平台处理（自验证） → 验证（Agent自动验收/第三方审计） → 微调（人） → 发布。
> 目标：最少打扰、强治理、结构化产出、可审计与可复用。

## 1) 意图采集（人）
- 输入：3–5 句简要需求（项目名、核心目标、核心场景、端数、外部依赖、预算阈值、时间线）。
- 产出：解析摘要、自动预填字段与置信度标签（触发式询问仅在缺失/冲突/低置信/超预算/外部依赖时出现）。
- 退出条件：关键意图字段齐备；低置信度项已标注。

## 2) 生成确认书（模板）
- 输入：模板 `docs/templates/software_dev_terms_template.md` + 自动抽取。
- 产出：条款确认书（草案），为一页式总览，所有关键与敏感项均标注“需要确认”。
- 域模型映射：`config/domain_schema/prd.json`、`stories.json`、`nfr.json`、`acceptance.json`、`risks.json`、`dependencies.json`。
- 退出条件：草案生成完成、必要条款均有默认值且可覆盖。

## 3) 人确认（一次性总览）
- 输入：条款确认书（草案）。
- 必须确认：范围与规模、核心场景与目标、AC/NFR、时间线与里程碑、预算与费用阈值、合规与数据处理、交付物与IP、变更与SLA。
- 退出条件：预算与外部调用授权明确；冲突项解决；条款冻结。

## 4) 平台处理（自动化 + 自验证）
- 输入：冻结条款。
- 产出：结构化工件 `prd.json / stories.json / nfr.json / acceptance.json` + 校验报告（Markdown）。
- 自验证门槛：
  - 必填项完整、无冲突、置信度 ≥ 0.7；
  - PRD 完整：范围/场景/目标/功能/交付物齐备；
  - Stories：每个核心故事具备 AC（≥1–3 条）；
  - NFR：性能/可靠性/安全/合规中 ≥3 类，阈值明确；
  - 预算与SLA：在阈值内或已设降级策略；外部依赖授权就绪。
- 协同脚本：`scripts/domain_validate.py`、`scripts/validate_config.py`、`scripts/routing_explain.py`、`scripts/timeline_view.py`、`scripts/generate_progress.py`。
- 退出条件：域模型校验与自验证报告通过。

## 5) 验证（Agent 自动验收 / 第三方审计）
- 输入：结构化工件与自验证报告。
- Agent 自动验收（强制）：契约校验、AC用例覆盖、关键NFR达标 → 生成验收报告。
- 第三方审计（可选并行）：性能压测、安全扫描、法务合规 → 生成审计报告。
- 退出条件：验收通过；若启用审计则审计合格。

## 6) 微调（人）
- 输入：差异清单（来自验收/审计报告）。
- 产出：修订条款与工件；如条款变更则回到“平台处理”再校验一次。
- 退出条件：差异闭合、风险缓解记录完备。

## 7) 发布
- 输入：通过验收的工件与报告。
- 产出：打包与版本推进（更新 `VERSION`、记录 `CHANGELOG.md`）、发布说明、上线清单（部署/回滚、监控与告警、SLA 联系人）。
- 流水线参考：`.github/workflows/release.yaml`。
- 退出条件：流水线通过，上线检查完成。

---

## 触发式询问策略
- 仅在以下场景提问：必填缺失或冲突、置信度 < 0.7、超预算、涉及外部或敏感数据、发布前总确认。
- 目的：最低打扰与最高信息密度，让确认集中在必要与敏感项。

## 云化编排映射
- 节点：意图采集 → 生成确认书 → 人确认 → 自动处理与自验证 → 自动验收 →（可选）第三方审计 → 人工微调 → 发布。
- 治理：成本阈值、合规白名单、外部调用审批、审计日志与报表。
- 效果：流程标准化、工件结构化、验收自动化，利于规模复用与多 Agent 协作。

## 示例与演示
- 条款确认书（Alpha）：`docs/examples/alpha_terms_confirmation.md`
- 进展快照（Alpha）：`docs/examples/alpha_progress_snapshot.json`
- 验收清单（Alpha）：`docs/examples/alpha_acceptance_checklist.md`

## 快速使用（Checklist）
- 一页式确认：在条款确认书中勾选/调整所有“需要确认”项。
- 自验证：运行校验脚本或测试套件，确保门槛达成。
- 验收：生成验收报告（自动），可选触发第三方审计。
- 发布：更新版本与变更，执行流水线与上线清单。

